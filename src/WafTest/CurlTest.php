<?php

/**
 * NOTICE OF LICENSE
 *
 * This source file is subject to the MIT licence
 * that is bundled with this package in the file LICENSE.
 * 
 * @author Jean-Baptiste Romain - Realdev.fr
 * @since 2023
 */

namespace Jbromain\WafPentest\WafTest;

use WafTestException;

class CurlTest implements WafTestInterface
{
    // -- Test static configurations --

    /** 
     * @var string 'POST' or 'GET' or other http method 
     */
    private string $method;

    /** 
     * @var string|array Value for CURLOPT_POSTFIELDS option 
     */
    private string|array $post_data;

    /**
     * @var string URL scheme. If not set, the test provider default value is used.
     */
    private string $scheme;

    /**
     * @var int TCP Port. If not set, the test provider default value is used.
     */
    private int $port;

    /** 
     * @var string Query starting with /. Scheme, domain and protocol will be added. 
     */
    private string $query;

    /**
     * @var array Keys are CURL_OPT constants names.
     * Values are string, int, boolean or array depending on the option.
     * @see https://www.php.net/manual/fr/function.curl-setopt.php
     */
    private array $curl_options = [];


    /**
     * Compute Curl options with default values.
     * Configuration names are: 'domain', 'default_scheme', 'default_port' and 'default_headers'
     * 
     * @param array $options Default configurations
     * @return bool True if the test is ready to be performed
     */
    public function prepare(array $options): bool
    {
        // TODO merge options in local perperties

        return true;
    }

    public function performTest(): bool
    {
        if (!function_exists('curl_version')) {
            throw new WafTestException('CURL is required');
        }

        // TODO Run curl using properties

        /*
        const('CURLOPT_URL')
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array(
            'accept: application/json',
            'X-Forwarded-For: ' . $ip
        ));
        */

        return false;
    }


    // TODO
}


/**
 * CURLOPT_URL: url cible
 * CURLOPT_INTERFACE: ip source à utiliser
 * CURLOPT_USERAGENT
 * CURLOPT_REFERER
 * CURLOPT_HTTPHEADER: tableau de headers
 * 
 * CURLOPT_POST true pour faire une requête post
 * CURLOPT_POSTFIELDS: données à envoyer en post
 * 
 * 
 */
